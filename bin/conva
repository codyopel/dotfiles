#!/usr/bin/env bash

source `lib-bash`

encode_file() {
  local AlbumArt
  local AlbumArtExt
  local Dir
  local File
  local FileName
  local InputDir
  local InSF
  local InSR
  local IsSourceMusicDir
  local OutputFile
  local OutputDir
  local RelOutDir

  File="$@"
  # Filename w/o ext
  FileName="$(basename "$(echo "${File}" | sed -r 's/\.[[:alnum:]]+$//')")"
  InputDir="$(dirname ${File})"

  if [ -n "$(echo "${File}" | grep '/Music/')" ] ; then
    IsSourceMusicDir="$(dirname "$(echo "${File}" | awk -F'/Music/' '{ print $2 ; exit }')")"
    OutputDir="${OUTPUT_DIRECTORY}${IsSourceMusicDir:+/${IsSourceMusicDir}}"
    if [ ! -d "${OutputDir}" ] ; then
      mkdir -pv "${OutputDir}"
    fi
  fi

  OutputFile="${OutputDir}/${FileName}.opus"

  # Input Sample Format/Rate
  if [ ! -f "${OutputFile}" ] ; then
    InSF="$(
      ffprobe -v error -select_streams 0 -show_entries stream=sample_fmt \
        -of default=noprint_wrappers=1:nokey=1 ${File})"
    InSR="$(
      ffprobe -v error -select_streams 0 -show_entries stream=sample_rate \
        -of default=noprint_wrappers=1:nokey=1 ${File})"
  fi

  # Check for album art image file
  if [ ! -f "${OutputDir}"/[Ff]older.*g ] ; then
    AlbumArt="$(
      find "${InputDir}" -type f -regextype posix-extended \
        -regex ".*[Ff]older.([Jj][Pp][Gg]|[Jj][Pp][Ee][Gg]|[Pp][Nn][Gg])" -print -quit)"
    AlbumArtExt="${AlbumArt##*.}"
    if [ -f "${AlbumArt}" -a ! -f "${OutputDir}/$(basename "${AlbumArt}")" ] ; then
      cp -v "${AlbumArt}" "${OutputDir}/$(basename "${AlbumArt}")"
    fi
  fi

  if [ ! -f "${OutputFile}" ] ; then
    ffmpeg \
      -hide_banner \
      -loglevel error \
      -y \
      -threads 1 \
      -i "${File}" \
      -c:a libopus \
      -b:a 128k \
      -vbr on \
      -compression_level 10 \
      -frame_duration 60 \
      -cutoff 20000 \
      -sample_fmt s16 \
      -ar 48000 \
      -ac 2 \
      -af "aresample=resampler=soxr:precision=28:cheby=1:isf=${InSF}:osf=s16:tsf=s32:isr=${InSR}:osr=48000:cutoff=0.91:dither_method=0" \
      -af "highpass=f=10:poles=1:width_type=h" \
      -af "lowpass=f=19600:poles=1:width_type=h" \
      -map_metadata 0 \
      -vn \
      "${OutputFile}" &
    FFmpegPid=$!
    # Wait for one encode to finish before starting another
    wait "${FFmpegPid}"
  fi

  #-af "compand=attacks=0|0:decays=1|1:points=-90/-900|-70/-70|-21/-21|0/-15:soft-knee=0.01:gain=0:volume=0:delay=0" \
}

Path::Check 'ffmpeg' || exit 1
Path::Check 'ffprobe' || exit 1

TMPDIR="$(mktemp -d)"
export OUTPUT_DIRECTORY="$(pwd)"
if [ "${OUTPUT_DIRECTORY}" == "${HOME}/Music" ] ; then
  echo "Can't encode in music directory"
  exit 1
fi
if [ -z "$@" ] ; then
  InputRaw=("${HOME}/.config/conva/music.list")
else
  InputRaw=("$@")
fi

if [ "$(basename "${InputRaw[0]}")" == 'music.list' ] ; then
  TmpArray=($(cat "$(dirname ${InputRaw[0]})/music.list"))
  for i in "${TmpArray[@]}" ; do
    InputDirectories+=("${HOME}/Music/${i}")
  done
else
  InputDirectories=("${InputRaw[@]}")
fi

export CONCURRENT_LIMIT=`Cpu::Logical`
export CONCURRENT_COMPACT=0

# Chunk encodes by directory to prevent hitting the BASH's function
# argument limit.
for Dir in "${InputDirectories[@]}" ; do
  # Clear previous file list
  echo '' > "$TMPDIR/filelist"
  # Check for valid audio files
  while read AudioFile ; do
    if [ ! -f "${AudioFile}" ] ; then
      continue
    fi
    Fname="$(basename "$(echo "${AudioFile}" | sed -r 's/\.[[:alnum:]]+$//')")"
    # Write list of audio files to a temp file
    echo "${Fname} ${AudioFile}" >> "${TMPDIR}/filelist"
  done <(
    find "${Dir}" \
      -type f \
      -regextype posix-extended \
      -regex ".*\.(ape|flac|ogg|m4a|mp3|wav|wma)" \
      2>> "${TMPDIR}/errors"
  )
  # Generate concurrent args from temp file list
  ConcurrentArgs=($(awk '{ print "- " $1 " encode_file " $2; }' ${TMPDIR}/filelist))
  Metadata="${ConcurrentArgs[2]}"
  # Remove invalid `- encode_file` created as first arg
  if [ "${ConcurrentArgs[2]}" == '-' ] ; then
    unset ConcurrentArgs[0]
    unset ConcurrentArgs[1]
    Metadata="${ConcurrentArgs[5]}"
  fi

  if [ -n "$(echo "${Metadata}" | grep '/Music/')" ] ; then
    Artist="$(echo "${Metadata}" | awk -F'/' '/Music/ {print $5}')"
    Album="$(echo "${Metadata}" | awk -F'/' '/Music/ {print $6}')"
  fi
  if [ -n "$(cat "${TMPDIR}/filelist")" ] ; then
    echo
    echo "Artist: ${Artist}"
    echo "Album: ${Album}"
    concurrent "${ConcurrentArgs[@]}"
  fi
done

if [ -f "${TMPDIR}/errors" ] ; then
  cat "${TMPDIR}/errors"
fi
